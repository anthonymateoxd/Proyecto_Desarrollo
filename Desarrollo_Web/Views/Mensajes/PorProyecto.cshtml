@model IEnumerable<DemonSlayer.Models.Mensaje>

@{
    var proyecto = ViewBag.Proyecto as DemonSlayer.Models.Proyecto;
    ViewData["Title"] = $"Chat - {proyecto?.Titulo}";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>💬 Chat del Proyecto</h1>
        <a asp-controller="Proyectos" asp-action="Index" class="btn btn-secondary">← Volver a Proyectos</a>
    </div>

    <!-- Información del Proyecto -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">@proyecto?.Titulo</h5>
            <p class="card-text">@proyecto?.Descripcion</p>
            <small class="text-muted">
                Presupuesto: Q @proyecto?.PresupuestoQ •
                Fecha límite: @proyecto?.FechaLimite.ToString("dd/MM/yyyy") •
                Cliente ID: @proyecto?.ClienteId
            </small>
        </div>
    </div>

    <!-- Área de Chat -->
    <div class="chat-container border rounded p-3 bg-light" style="max-height: 500px; overflow-y: auto;">
        @if (Model.Any())
        {
            foreach (var mensaje in Model)
            {
                var esMio = mensaje.RemitenteId == ViewBag.UserId;
                var nombreRemitente = ViewBag.Usuarios[mensaje.RemitenteId] as string ?? $"Usuario #{mensaje.RemitenteId}";

                <div class="message @(esMio ? "message-sent" : "message-received") mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="@(esMio ? "ms-auto" : "")" style="max-width: 70%;">
                            <strong class="@(esMio ? "text-primary" : "text-success")">
                                @(esMio ? "Tú" : nombreRemitente)
                            </strong>
                            <div class="message-text @(esMio ? "bg-primary text-white" : "bg-white") p-2 rounded border">
                                @mensaje.Texto
                            </div>
                        </div>
                        <small class="text-muted">@mensaje.Fecha.ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center text-muted py-4">
                <p>💬 No hay mensajes en este proyecto todavía.</p>
                <p>¡Sé el primero en enviar un mensaje!</p>
            </div>
        }
    </div>

    <!-- Botón para enviar nuevo mensaje -->
    <div class="mt-3 text-center">
        <a asp-action="Create" asp-route-proyectoId="@proyecto?.Id" class="btn btn-success btn-lg">
            💬 Enviar Mensaje
        </a>
    </div>
</div>

<style>
    .chat-container {
        background-color: #f8f9fa;
    }

    .message-sent {
        text-align: right;
    }

    .message-received {
        text-align: left;
    }

    .message-text {
        word-wrap: break-word;
    }
</style>